# =========== 生产环境 ===========

# 环境变量
variables:
  DB_HOST: 118.25.95.207
  DB_PORT: 3306
  DB_NAME: eladmin_template
  DB_USER: eladmin_template
  DB_PWD: EladminTemplate@2021
  REDIS_HOST: 118.25.95.207
  REDIS_PORT: 6379
  REDIS_PWD: lQrVBDbu9rR7T3oY
  REDIS_DB: 9
  DRUID_USER: admin
  DRUID_PWD: QrVBDbu9rR7T3o

# 构建
prod-build:
  stage: compile
  script:
    - echo "=============== 开始编译构建任务 ==============="
    - $MAVEN_HOME/bin/mvn compile
    - echo '$DB_HOST'
  #  tags:
  #    - xxx
  only:
    - master

# 生产环境打包
prod-package:
  stage: package
  script:
    - echo "=============== 开始打包任务  ==============="
    # 清缓存
    - mvn clean
    # 打包
    - mvn package -Dmaven.test.skip=true
    # 停止服务
    - sh stop.sh
    # 删除jar包
    - rm -rf /server/eladmin/eladmin-template.jar
    # copy到指定位置
    - cp ./eladmin-system/target/eladmin-template.jar /server/eladmin
    - cp start.sh /server/eladmin
    - cd /server/eladmin
    # 启动服务
    - 'nohup java -jar /server/eladmin/eladmin-template.jar \
      --DB_HOST=$DB_HOST \
      --DB_PORT=$DB_PORT \
      --DB_NAME=$DB_NAME \
      --DB_USER=$DB_USER \
      --DB_PWD=$DB_PWD \
      --REDIS_HOST=$REDIS_HOST \
      --REDIS_PORT=$REDIS_PORT \
      --REDIS_PWD=$REDIS_PWD \
      --REDIS_DB=$REDIS_DB \
      --DRUID_USER=$DRUID_USER \
      --DRUID_PWD=$DRUID_PWD > nohup.out 2>&1 &'
  #    artifacts:
  #      paths:
  #        - target/*.jar
  #    tags:
  #      - xxx
  only:
    - master
